<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Vista de Lista/Tree extendida para Citas -->
    <record id="view_calendar_event_list_cutai" model="ir.ui.view">
        <field name="name">calendar.event.list.cutai</field>
        <field name="model">calendar.event</field>
        <field name="inherit_id" ref="calendar.view_calendar_event_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//list" position="attributes">
                <attribute name="decoration-info">appointment_state == 'reserved'</attribute>
                <attribute name="decoration-warning">appointment_state == 'confirmed'</attribute>
                <attribute name="decoration-primary">appointment_state == 'attended'</attribute>
                <attribute name="decoration-danger">appointment_state == 'pending'</attribute>
                <attribute name="decoration-muted">appointment_state == 'no_show'</attribute>
                <attribute name="decoration-success">appointment_state == 'waiting'</attribute>
            </xpath>
            <xpath expr="//field[@name='start']" position="after">
                <field name="realization_date" optional="show"/>
                <field name="create_date" optional="hide"/>
                <field name="create_uid" optional="hide"/>
                <field name="write_date" optional="hide"/>
                <field name="write_uid" optional="hide"/>
                <field name="branch_id" optional="show"/>
                <field name="client_number" optional="show"/>
                <field name="client_first_name" optional="show"/>
                <field name="client_last_name" optional="show"/>
                <field name="client_email" optional="hide"/>
                <field name="client_phone" optional="show"/>
                <field name="client_vat" optional="hide"/>
                <field name="main_service_id" optional="show"/>
                <field name="list_price" optional="show"/>
                <field name="real_price" optional="show"/>
                <field name="session_number" optional="show"/>
                <field name="total_sessions" optional="show"/>
                <field name="attendant_id" optional="show"/>
                <field name="appointment_state" optional="show"/>
                <field name="payment_status" optional="show"/>
                <field name="payment_date" optional="hide"/>
                <field name="payment_id" optional="hide"/>
                <field name="origin" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Vista de Formulario extendida para Citas -->
    <record id="view_calendar_event_form_cutai" model="ir.ui.view">
        <field name="name">calendar.event.form.cutai</field>
        <field name="model">calendar.event</field>
        <field name="inherit_id" ref="calendar.view_calendar_event_form"/>
        <field name="arch" type="xml">
            <!-- Agregar header con botones de estado al principio del form -->
            <xpath expr="//form/sheet" position="before">
                <header>
                    <button name="action_confirm_appointment" 
                            string="Confirmar" 
                            type="object" 
                            invisible="appointment_state not in ['reserved', 'pending']" 
                            class="oe_highlight"/>
                    <button name="action_mark_attended" 
                            string="Asiste" 
                            type="object" 
                            invisible="appointment_state not in ['confirmed', 'waiting']" 
                            class="oe_highlight"/>
                    <button name="action_mark_waiting" 
                            string="En Espera" 
                            type="object" 
                            invisible="appointment_state not in ['reserved', 'confirmed']"/>
                    <button name="action_mark_no_show" 
                            string="No Asiste" 
                            type="object" 
                            invisible="appointment_state not in ['reserved', 'confirmed', 'waiting']"/>
                    <button name="action_cancel_appointment" 
                            string="Cancelar" 
                            type="object" 
                            invisible="appointment_state in ['attended', 'cancelled']"/>
                    <field name="appointment_state" widget="statusbar" statusbar_visible="reserved,confirmed,attended"/>
                </header>
            </xpath>

            <!-- Agregar pestanas CUTAI al notebook existente -->
            <xpath expr="//page[@name='page_invitations']" position="after">
                <page string="Información del Cliente" name="page_client_info">
                    <group>
                        <group string="Cliente Principal">
                            <field name="main_partner_id" readonly="1" 
                                   options="{'no_create': True, 'no_open': False}"
                                   context="{'show_address': 1}"/>
                            <field name="client_number" readonly="1"/>
                            <field name="client_vat" readonly="1"/>
                        </group>
                        <group string="Datos de Contacto">
                            <field name="client_email" widget="email" readonly="1"/>
                            <field name="client_phone" widget="phone" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group string="Información Personal">
                            <field name="client_first_name" readonly="1"/>
                            <field name="client_last_name" readonly="1"/>
                        </group>
                        <group string="Origen y Preferencias">
                            <field name="origin"/>
                            <field name="client_preference" 
                                   placeholder="Horarios preferidos, terapeuta preferido, observaciones especiales..."/>
                        </group>
                    </group>
                </page>
                    
                <page string="Local y Recursos" name="page_location">
                    <group>
                        <group string="Ubicación">
                            <field name="branch_id" options="{'no_create': True}"/>
                            <field name="cabin_id" options="{'no_create': True}"/>
                        </group>
                        <group string="Recursos y Personal">
                            <field name="machine_id" options="{'no_create': True}"/>
                            <field name="attendant_id" options="{'no_create': True}"/>
                        </group>
                    </group>
                </page>
                    
                <page string="Servicio y Precios" name="page_service">
                    <group>
                        <group string="Servicio">
                            <field name="main_service_id" options="{'no_create': True}"/>
                            <field name="realization_date" readonly="1" 
                                   string="Fecha de Realización"/>
                        </group>
                        <group string="Sesiones">
                            <label for="session_number" string="Progreso de Sesiones"/>
                            <div class="o_row">
                                <field name="session_number" class="oe_inline"/> 
                                <span class="oe_inline"> de </span>
                                <field name="total_sessions" class="oe_inline"/>
                            </div>
                        </group>
                    </group>
                    <group>
                        <group string="Precios">
                            <field name="list_price"/>
                            <field name="real_price"/>
                        </group>
                        <group string="Estado de Pago">
                            <field name="payment_status" widget="badge"
                                   decoration-success="payment_status == 'paid'"
                                   decoration-warning="payment_status == 'pending'"
                                   decoration-info="payment_status == 'partial'"/>
                            <field name="payment_date"/>
                            <field name="payment_id"/>
                        </group>
                    </group>
                </page>
                
                <page string="Parámetros de Tratamiento" name="page_treatment_params">
                    <group>
                        <group string="Parámetros del Láser">
                            <field name="laser_type"/>
                            <field name="spot_size"/>
                            <field name="hair_type_last_session"/>
                            <field name="shot_width"/>
                        </group>
                        <group string="Notas del Tratamiento">
                            <field name="treatment_note" nolabel="1" placeholder="Observaciones específicas de esta sesión..."/>
                        </group>
                    </group>
                </page>
                    
                <page string="Notas y Comentarios" name="page_notes">
                    <group>
                        <group>
                            <separator string="Notas Compartidas"/>
                            <field name="shared_notes" nolabel="1"
                                   placeholder="Notas que el cliente puede ver (instrucciones post-tratamiento, recomendaciones, etc.)..."/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <separator string="Comentarios Internos"/>
                            <field name="internal_notes" nolabel="1"
                                   placeholder="Comentarios privados del personal (observaciones del tratamiento, reacciones, etc.)..."/>
                        </group>
                    </group>
                    <group>
                        <field name="description" nolabel="1" 
                               placeholder="Descripción general de la cita..."/>
                    </group>
                </page>
                    
                <page string="Notificaciones WhatsApp" name="page_whatsapp">
                    <group>
                        <div class="alert alert-info" role="alert" style="margin-bottom: 10px;">
                            <strong>Información:</strong> Puedes marcar manualmente estas notificaciones si ya fueron enviadas por otro medio.
                        </div>
                    </group>
                    <group string="Estado de Notificaciones">
                        <group>
                            <field name="whatsapp_notification_sent" 
                                   widget="boolean"
                                   string="Confirmación Enviada"/>
                            <field name="whatsapp_reminder_48h_sent" 
                                   widget="boolean"
                                   string="Recordatorio 48h Enviado"/>
                        </group>
                        <group>
                            <field name="whatsapp_reminder_24h_sent" 
                                   widget="boolean"
                                   string="Recordatorio 24h Enviado"/>
                            <field name="whatsapp_reminder_3h_sent" 
                                   widget="boolean"
                                   string="Recordatorio 3h Enviado"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <button name="send_whatsapp_notification" 
                                    string="Enviar Confirmación WhatsApp" 
                                    type="object" 
                                    class="btn-primary"
                                    invisible="whatsapp_notification_sent == True"/>
                            <button name="send_whatsapp_reminder_48h" 
                                    string="Enviar Recordatorio 48h" 
                                    type="object" 
                                    class="btn-secondary"
                                    invisible="whatsapp_reminder_48h_sent == True"/>
                        </group>
                        <group>
                            <button name="send_whatsapp_reminder_24h" 
                                    string="Enviar Recordatorio 24h" 
                                    type="object" 
                                    class="btn-secondary"
                                    invisible="whatsapp_reminder_24h_sent == True"/>
                            <button name="send_whatsapp_reminder_3h" 
                                    string="Enviar Recordatorio 3h" 
                                    type="object" 
                                    class="btn-secondary"
                                    invisible="whatsapp_reminder_3h_sent == True"/>
                        </group>
                    </group>
                </page>
                
                <page string="Auditoría" name="page_audit">
                    <group string="Información de Creación y Modificación">
                        <group>
                            <field name="create_date" readonly="1" string="Creado el"/>
                            <field name="create_uid" readonly="1" string="Creado por"/>
                        </group>
                        <group>
                            <field name="write_date" readonly="1" string="Última modificación"/>
                            <field name="write_uid" readonly="1" string="Modificado por"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Vista de Calendario personalizada para CUTAI -->
    <record id="view_calendar_event_calendar_cutai" model="ir.ui.view">
        <field name="name">calendar.event.calendar.cutai</field>
        <field name="model">calendar.event</field>
        <field name="inherit_id" ref="calendar.view_calendar_event_calendar"/>
        <field name="arch" type="xml">
            <xpath expr="//calendar" position="attributes">
                <attribute name="color">branch_id</attribute>
                <attribute name="event_open_popup">true</attribute>
                <attribute name="quick_create">false</attribute>
            </xpath>
            <xpath expr="//calendar" position="inside">
                <field name="branch_id"/>
                <field name="attendant_id"/>
                <field name="main_service_id"/>
                <field name="appointment_state"/>
                <field name="client_first_name"/>
                <field name="client_last_name"/>
            </xpath>
        </field>
    </record>

    <!-- Vista Gantt/Timeline para CUTAI -->
    <record id="view_calendar_event_gantt_cutai" model="ir.ui.view">
        <field name="name">calendar.event.gantt.cutai</field>
        <field name="model">calendar.event</field>
        <field name="arch" type="xml">
            <gantt string="Timeline de Citas"
                   date_start="start"
                   date_stop="stop"
                   default_group_by="attendant_id"
                   color="appointment_state">
                <field name="branch_id"/>
                <field name="attendant_id"/>
                <field name="main_service_id"/>
                <field name="appointment_state"/>
                <field name="client_first_name"/>
                <field name="client_last_name"/>
            </gantt>
        </field>
    </record>

    <!-- Acción para ver citas CUTAI -->
    <record id="action_calendar_event_cutai" model="ir.actions.act_window">
        <field name="name">Agenda CUTAI</field>
        <field name="res_model">calendar.event</field>
        <field name="view_mode">list,calendar,gantt,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'list', 'view_id': ref('view_calendar_event_list_cutai')}),
            (0, 0, {'view_mode': 'calendar', 'view_id': ref('view_calendar_event_calendar_cutai')}),
            (0, 0, {'view_mode': 'gantt', 'view_id': ref('view_calendar_event_gantt_cutai')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('view_calendar_event_form_cutai')})]"/>
        <field name="context">{
            'default_appointment_state': 'reserved',
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crea tu primera cita
            </p>
            <p>
                Gestiona las citas de tus clientes con todos los detalles: servicios, precios, sesiones y pagos.
            </p>
        </field>
    </record>

    <!-- Filtros de búsqueda -->
    <record id="view_calendar_event_search_cutai" model="ir.ui.view">
        <field name="name">calendar.event.search.cutai</field>
        <field name="model">calendar.event</field>
        <field name="inherit_id" ref="calendar.view_calendar_event_search"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <field name="branch_id"/>
                <field name="attendant_id"/>
                <field name="main_service_id"/>
                <field name="client_number"/>
                <field name="client_vat"/>
                <field name="origin"/>
                <separator/>
                <filter name="today" string="Hoy" domain="[('start', '&gt;=', datetime.datetime.now().strftime('%Y-%m-%d 00:00:00')), ('start', '&lt;=', datetime.datetime.now().strftime('%Y-%m-%d 23:59:59'))]"/>
                <filter name="this_week" string="Esta Semana" domain="[('start', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')), ('start', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter name="reserved" string="Reservadas" domain="[('appointment_state', '=', 'reserved')]"/>
                <filter name="confirmed" string="Confirmadas" domain="[('appointment_state', '=', 'confirmed')]"/>
                <filter name="attended" string="Asisten" domain="[('appointment_state', '=', 'attended')]"/>
                <filter name="pending" string="Pendientes" domain="[('appointment_state', '=', 'pending')]"/>
                <filter name="waiting" string="En Espera" domain="[('appointment_state', '=', 'waiting')]"/>
                <filter name="no_show" string="No Asisten" domain="[('appointment_state', '=', 'no_show')]"/>
                <filter name="cancelled" string="Canceladas" domain="[('appointment_state', '=', 'cancelled')]"/>
                <separator/>
                <filter name="pending_payment" string="Pago Pendiente" domain="[('payment_status', '=', 'pending')]"/>
                <filter name="paid" string="Pagadas" domain="[('payment_status', '=', 'paid')]"/>
                <separator/>
                <group expand="0" string="Agrupar Por">
                    <filter name="group_branch" string="Sucursal" context="{'group_by': 'branch_id'}"/>
                    <filter name="group_attendant" string="Profesional" context="{'group_by': 'attendant_id'}"/>
                    <filter name="group_service" string="Servicio" context="{'group_by': 'main_service_id'}"/>
                    <filter name="group_state" string="Estado" context="{'group_by': 'appointment_state'}"/>
                    <filter name="group_date" string="Fecha" context="{'group_by': 'start:day'}"/>
                    <filter name="group_origin" string="Origen" context="{'group_by': 'origin'}"/>
                    <filter name="group_payment" string="Estado Pago" context="{'group_by': 'payment_status'}"/>
                </group>
            </xpath>
        </field>
    </record>

</odoo>
